'use client';

import { useState, Suspense, type FC } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { sendLoginOtp } from '@/ai/flows/send-login-otp';
import { findUserByWhatsapp } from '@/services/player-service';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';
import { Loader2, KeyRound, Check } from 'lucide-react';
import type { MasterPlayer } from '@/lib/types';
import { Popover, PopoverTrigger, PopoverContent } from '@/components/ui/popover';
import { Command, CommandInput, CommandEmpty, CommandGroup, CommandItem, CommandList } from '@/components/ui/command';
import { ScrollArea } from '@/components/ui/scroll-area';
import { cn } from '@/lib/utils';
import { getClub } from '@/services/club-service';
import { verifyWhatsappNumber } from '@/ai/flows/verify-whatsapp-number';


const countries = [
    { name: 'Afghanistan', code: '93', flag: 'ğŸ‡¦ğŸ‡«' },
    { name: 'Albania', code: '355', flag: 'ğŸ‡¦ğŸ‡±' },
    { name: 'Algeria', code: '213', flag: 'ğŸ‡©ğŸ‡¿' },
    { name: 'American Samoa', code: '1-684', flag: 'ğŸ‡¦ğŸ‡¸' },
    { name: 'Andorra', code: '376', flag: 'ğŸ‡¦ğŸ‡©' },
    { name: 'Angola', code: '244', flag: 'ğŸ‡¦ğŸ‡´' },
    { name: 'Anguilla', code: '1-264', flag: 'ğŸ‡¦ğŸ‡®' },
    { name: 'Antigua and Barbuda', code: '1-268', flag: 'ğŸ‡¦ğŸ‡¬' },
    { name: 'Argentina', code: '54', flag: 'ğŸ‡¦ğŸ‡·' },
    { name: 'Armenia', code: '374', flag: 'ğŸ‡¦ğŸ‡²' },
    { name: 'Aruba', code: '297', flag: 'ğŸ‡¦ğŸ‡¼' },
    { name: 'Australia', code: '61', flag: 'ğŸ‡¦ğŸ‡º' },
    { name: 'Austria', code: '43', flag: 'ğŸ‡¦ğŸ‡¹' },
    { name: 'Azerbaijan', code: '994', flag: 'ğŸ‡¦ğŸ‡¿' },
    { name: 'Bahamas', code: '1-242', flag: 'ğŸ‡§ğŸ‡¸' },
    { name: 'Bahrain', code: '973', flag: 'ğŸ‡§ğŸ‡­' },
    { name: 'Bangladesh', code: '880', flag: 'ğŸ‡§ğŸ‡©' },
    { name: 'Barbados', code: '1-246', flag: 'ğŸ‡§ğŸ‡§' },
    { name: 'Belarus', code: '375', flag: 'ğŸ‡§ğŸ‡¾' },
    { name: 'Belgium', code: '32', flag: 'ğŸ‡§ğŸ‡ª' },
    { name: 'Belize', code: '501', flag: 'ğŸ‡§ğŸ‡¿' },
    { name: 'Benin', code: '229', flag: 'ğŸ‡§ğŸ‡¯' },
    { name: 'Bermuda', code: '1-441', flag: 'ğŸ‡§ğŸ‡²' },
    { name: 'Bhutan', code: '975', flag: 'ğŸ‡§ğŸ‡¹' },
    { name: 'Bolivia', code: '591', flag: 'ğŸ‡§ğŸ‡´' },
    { name: 'Bosnia and Herzegovina', code: '387', flag: 'ğŸ‡§ğŸ‡¦' },
    { name: 'Botswana', code: '267', flag: 'ğŸ‡§ğŸ‡¼' },
    { name: 'Brazil', code: '55', flag: 'ğŸ‡§ğŸ‡·' },
    { name: 'British Indian Ocean Territory', code: '246', flag: 'ğŸ‡®ğŸ‡´' },
    { name: 'British Virgin Islands', code: '1-284', flag: 'ğŸ‡»ğŸ‡¬' },
    { name: 'Brunei', code: '673', flag: 'ğŸ‡§ğŸ‡³' },
    { name: 'Bulgaria', code: '359', flag: 'ğŸ‡§ğŸ‡¬' },
    { name: 'Burkina Faso', code: '226', flag: 'ğŸ‡§ğŸ‡«' },
    { name: 'Burundi', code: '257', flag: 'ğŸ‡§ğŸ‡®' },
    { name: 'Cambodia', code: '855', flag: 'ğŸ‡°ğŸ‡­' },
    { name: 'Cameroon', code: '237', flag: 'ğŸ‡¨ğŸ‡²' },
    { name: 'Canada', code: '1', flag: 'ğŸ‡¨ğŸ‡¦' },
    { name: 'Cape Verde', code: '238', flag: 'ğŸ‡¨ğŸ‡»' },
    { name: 'Cayman Islands', code: '1-345', flag: 'ğŸ‡°ğŸ‡¾' },
    { name: 'Central African Republic', code: '236', flag: 'ğŸ‡¨ğŸ‡«' },
    { name: 'Chad', code: '235', flag: 'ğŸ‡¹ğŸ‡©' },
    { name: 'Chile', code: '56', flag: 'ğŸ‡¨ğŸ‡±' },
    { name: 'China', code: '86', flag: 'ğŸ‡¨ğŸ‡³' },
    { name: 'Christmas Island', code: '61', flag: 'ğŸ‡¨ğŸ‡½' },
    { name: 'Cocos Islands', code: '61', flag: 'ğŸ‡¨ğŸ‡¨' },
    { name: 'Colombia', code: '57', flag: 'ğŸ‡¨ğŸ‡´' },
    { name: 'Comoros', code: '269', flag: 'ğŸ‡°ğŸ‡²' },
    { name: 'Cook Islands', code: '682', flag: 'ğŸ‡¨ğŸ‡°' },
    { name: 'Costa Rica', code: '506', flag: 'ğŸ‡¨ğŸ‡·' },
    { name: 'Croatia', code: '385', flag: 'ğŸ‡­ğŸ‡·' },
    { name: 'Cuba', code: '53', flag: 'ğŸ‡¨ğŸ‡º' },
    { name: 'Curacao', code: '599', flag: 'ğŸ‡¨ğŸ‡¼' },
    { name: 'Cyprus', code: '357', flag: 'ğŸ‡¨ğŸ‡¾' },
    { name: 'Czech Republic', code: '420', flag: 'ğŸ‡¨ğŸ‡¿' },
    { name: 'Democratic Republic of the Congo', code: '243', flag: 'ğŸ‡¨ğŸ‡©' },
    { name: 'Denmark', code: '45', flag: 'ğŸ‡©ğŸ‡°' },
    { name: 'Djibouti', code: '253', flag: 'ğŸ‡©ğŸ‡¯' },
    { name: 'Dominica', code: '1-767', flag: 'ğŸ‡©ğŸ‡²' },
    { name: 'Dominican Republic', code: '1-809', flag: 'ğŸ‡©ğŸ‡´' },
    { name: 'East Timor', code: '670', flag: 'ğŸ‡¹ğŸ‡±' },
    { name: 'Ecuador', code: '593', flag: 'ğŸ‡ªğŸ‡¨' },
    { name: 'Egypt', code: '20', flag: 'ğŸ‡ªğŸ‡¬' },
    { name: 'El Salvador', code: '503', flag: 'ğŸ‡¸ğŸ‡»' },
    { name: 'Equatorial Guinea', code: '240', flag: 'ğŸ‡¬ğŸ‡¶' },
    { name: 'Eritrea', code: '291', flag: 'ğŸ‡ªğŸ‡·' },
    { name: 'Estonia', code: '372', flag: 'ğŸ‡ªğŸ‡ª' },
    { name: 'Ethiopia', code: '251', flag: 'ğŸ‡ªğŸ‡¹' },
    { name: 'Falkland Islands', code: '500', flag: 'ğŸ‡«ğŸ‡°' },
    { name: 'Faroe Islands', code: '298', flag: 'ğŸ‡«ğŸ‡´' },
    { name: 'Fiji', code: '679', flag: 'ğŸ‡«ğŸ‡¯' },
    { name: 'Finland', code: '358', flag: 'ğŸ‡«ğŸ‡®' },
    { name: 'France', code: '33', flag: 'ğŸ‡«ğŸ‡·' },
    { name: 'French Polynesia', code: '689', flag: 'ğŸ‡µğŸ‡«' },
    { name: 'Gabon', code: '241', flag: 'ğŸ‡¬ğŸ‡¦' },
    { name: 'Gambia', code: '220', flag: 'ğŸ‡¬ğŸ‡²' },
    { name: 'Georgia', code: '995', flag: 'ğŸ‡¬ğŸ‡ª' },
    { name: 'Germany', code: '49', flag: 'ğŸ‡©ğŸ‡ª' },
    { name: 'Ghana', code: '233', flag: 'ğŸ‡¬ğŸ‡­' },
    { name: 'Gibraltar', code: '350', flag: 'ğŸ‡¬ğŸ‡®' },
    { name: 'Greece', code: '30', flag: 'ğŸ‡¬ğŸ‡·' },
    { name: 'Greenland', code: '299', flag: 'ğŸ‡¬ğŸ‡±' },
    { name: 'Grenada', code: '1-473', flag: 'ğŸ‡¬ğŸ‡©' },
    { name: 'Guam', code: '1-671', flag: 'ğŸ‡¬ğŸ‡º' },
    { name: 'Guatemala', code: '502', flag: 'ğŸ‡¬ğŸ‡¹' },
    { name: 'Guernsey', code: '44-1481', flag: 'ğŸ‡¬ğŸ‡¬' },
    { name: 'Guinea', code: '224', flag: 'ğŸ‡¬ğŸ‡³' },
    { name: 'Guinea-Bissau', code: '245', flag: 'ğŸ‡¬ğŸ‡¼' },
    { name: 'Guyana', code: '592', flag: 'ğŸ‡¬ğŸ‡¾' },
    { name: 'Haiti', code: '509', flag: 'ğŸ‡­ğŸ‡¹' },
    { name: 'Honduras', code: '504', flag: 'ğŸ‡­ğŸ‡³' },
    { name: 'Hong Kong', code: '852', flag: 'ğŸ‡­ğŸ‡°' },
    { name: 'Hungary', code: '36', flag: 'ğŸ‡­ğŸ‡º' },
    { name: 'Iceland', code: '354', flag: 'ğŸ‡®ğŸ‡¸' },
    { name: 'India', code: '91', flag: 'ğŸ‡®ğŸ‡³' },
    { name: 'Indonesia', code: '62', flag: 'ğŸ‡®ğŸ‡©' },
    { name: 'Iran', code: '98', flag: 'ğŸ‡®ğŸ‡·' },
    { name: 'Iraq', code: '964', flag: 'ğŸ‡®ğŸ‡¶' },
    { name: 'Ireland', code: '353', flag: 'ğŸ‡®ğŸ‡ª' },
    { name: 'Isle of Man', code: '44-1624', flag: 'ğŸ‡®ğŸ‡²' },
    { name: 'Israel', code: '972', flag: 'ğŸ‡®ğŸ‡±' },
    { name: 'Italy', code: '39', flag: 'ğŸ‡®ğŸ‡¹' },
    { name: 'Ivory Coast', code: '225', flag: 'ğŸ‡¨ğŸ‡®' },
    { name: 'Jamaica', code: '1-876', flag: 'ğŸ‡¯ğŸ‡²' },
    { name: 'Japan', code: '81', flag: 'ğŸ‡¯ğŸ‡µ' },
    { name: 'Jersey', code: '44-1534', flag: 'ğŸ‡¯ğŸ‡ª' },
    { name: 'Jordan', code: '962', flag: 'ğŸ‡¯ğŸ‡´' },
    { name: 'Kazakhstan', code: '7', flag: 'ğŸ‡°ğŸ‡¿' },
    { name: 'Kenya', code: '254', flag: 'ğŸ‡°ğŸ‡ª' },
    { name: 'Kiribati', code: '686', flag: 'ğŸ‡°ğŸ‡®' },
    { name: 'Kosovo', code: '383', flag: 'ğŸ‡½ğŸ‡°' },
    { name: 'Kuwait', code: '965', flag: 'ğŸ‡°ğŸ‡¼' },
    { name: 'Kyrgyzstan', code: '996', flag: 'ğŸ‡°ğŸ‡¬' },
    { name: 'Laos', code: '856', flag: 'ğŸ‡±ğŸ‡¦' },
    { name: 'Latvia', code: '371', flag: 'ğŸ‡±ğŸ‡»' },
    { name: 'Lebanon', code: '961', flag: 'ğŸ‡±ğŸ‡§' },
    { name: 'Lesotho', code: '266', flag: 'ğŸ‡±ğŸ‡¸' },
    { name: 'Liberia', code: '231', flag: 'ğŸ‡±ğŸ‡·' },
    { name: 'Libya', code: '218', flag: 'ğŸ‡±ğŸ‡¾' },
    { name: 'Liechtenstein', code: '423', flag: 'ğŸ‡±ğŸ‡®' },
    { name: 'Lithuania', code: '370', flag: 'ğŸ‡±ğŸ‡¹' },
    { name: 'Luxembourg', code: '352', flag: 'ğŸ‡±ğŸ‡º' },
    { name: 'Macau', code: '853', flag: 'ğŸ‡²ğŸ‡´' },
    { name: 'Macedonia', code: '389', flag: 'ğŸ‡²ğŸ‡°' },
    { name: 'Madagascar', code: '261', flag: 'ğŸ‡²ğŸ‡¬' },
    { name: 'Malawi', code: '265', flag: 'ğŸ‡²ğŸ‡¼' },
    { name: 'Malaysia', code: '60', flag: 'ğŸ‡²ğŸ‡¾' },
    { name: 'Maldives', code: '960', flag: 'ğŸ‡²ğŸ‡»' },
    { name: 'Mali', code: '223', flag: 'ğŸ‡²ğŸ‡±' },
    { name: 'Malta', code: '356', flag: 'ğŸ‡²ğŸ‡¹' },
    { name: 'Marshall Islands', code: '692', flag: 'ğŸ‡²ğŸ‡­' },
    { name: 'Mauritania', code: '222', flag: 'ğŸ‡²ğŸ‡·' },
    { name: 'Mauritius', code: '230', flag: 'ğŸ‡²ğŸ‡º' },
    { name: 'Mayotte', code: '262', flag: 'ğŸ‡¾ğŸ‡¹' },
    { name: 'Mexico', code: '52', flag: 'ğŸ‡²ğŸ‡½' },
    { name: 'Micronesia', code: '691', flag: 'ğŸ‡«ğŸ‡²' },
    { name: 'Moldova', code: '373', flag: 'ğŸ‡²ğŸ‡©' },
    { name: 'Monaco', code: '377', flag: 'ğŸ‡²ğŸ‡¨' },
    { name: 'Mongolia', code: '976', flag: 'ğŸ‡²ğŸ‡³' },
    { name: 'Montenegro', code: '382', flag: 'ğŸ‡²ğŸ‡ª' },
    { name: 'Montserrat', code: '1-664', flag: 'ğŸ‡²ğŸ‡¸' },
    { name: 'Morocco', code: '212', flag: 'ğŸ‡²ğŸ‡¦' },
    { name: 'Mozambique', code: '258', flag: 'ğŸ‡²ğŸ‡¿' },
    { name: 'Myanmar', code: '95', flag: 'ğŸ‡²ğŸ‡²' },
    { name: 'Namibia', code: '264', flag: 'ğŸ‡³ğŸ‡¦' },
    { name: 'Nauru', code: '674', flag: 'ğŸ‡³ğŸ‡·' },
    { name: 'Nepal', code: '977', flag: 'ğŸ‡³ğŸ‡µ' },
    { name: 'Netherlands', code: '31', flag: 'ğŸ‡³ğŸ‡±' },
    { name: 'Netherlands Antilles', code: '599', flag: 'ğŸ‡§ğŸ‡¶' },
    { name: 'New Caledonia', code: '687', flag: 'ğŸ‡³ğŸ‡¨' },
    { name: 'New Zealand', code: '64', flag: 'ğŸ‡³ğŸ‡¿' },
    { name: 'Nicaragua', code: '505', flag: 'ğŸ‡³ğŸ‡®' },
    { name: 'Niger', code: '227', flag: 'ğŸ‡³ğŸ‡ª' },
    { name: 'Nigeria', code: '234', flag: 'ğŸ‡³ğŸ‡¬' },
    { name: 'Niue', code: '683', flag: 'ğŸ‡³ğŸ‡º' },
    { name: 'Northern Mariana Islands', code: '1-670', flag: 'ğŸ‡²ğŸ‡µ' },
    { name: 'North Korea', code: '850', flag: 'ğŸ‡°ğŸ‡µ' },
    { name: 'Norway', code: '47', flag: 'ğŸ‡³ğŸ‡´' },
    { name: 'Oman', code: '968', flag: 'ğŸ‡´ğŸ‡²' },
    { name: 'Pakistan', code: '92', flag: 'ğŸ‡µğŸ‡°' },
    { name: 'Palau', code: '680', flag: 'ğŸ‡µğŸ‡¼' },
    { name: 'Palestine', code: '970', flag: 'ğŸ‡µğŸ‡¸' },
    { name: 'Panama', code: '507', flag: 'ğŸ‡µğŸ‡¦' },
    { name: 'Papua New Guinea', code: '675', flag: 'ğŸ‡µğŸ‡¬' },
    { name: 'Paraguay', code: '595', flag: 'ğŸ‡µğŸ‡¾' },
    { name: 'Peru', code: '51', flag: 'ğŸ‡µğŸ‡ª' },
    { name: 'Philippines', code: '63', flag: 'ğŸ‡µğŸ‡­' },
    { name: 'Pitcairn', code: '64', flag: 'ğŸ‡µğŸ‡³' },
    { name: 'Poland', code: '48', flag: 'ğŸ‡µğŸ‡±' },
    { name: 'Portugal', code: '351', flag: 'ğŸ‡µğŸ‡¹' },
    { name: 'Puerto Rico', code: '1-787', flag: 'ğŸ‡µğŸ‡·' },
    { name: 'Qatar', code: '974', flag: 'ğŸ‡¶ğŸ‡¦' },
    { name: 'Republic of the Congo', code: '242', flag: 'ğŸ‡¨ğŸ‡¬' },
    { name: 'Reunion', code: '262', flag: 'ğŸ‡·ğŸ‡ª' },
    { name: 'Romania', code: '40', flag: 'ğŸ‡·ğŸ‡´' },
    { name: 'Russia', code: '7', flag: 'ğŸ‡·ğŸ‡º' },
    { name: 'Rwanda', code: '250', flag: 'ğŸ‡·ğŸ‡¼' },
    { name: 'Saint Barthelemy', code: '590', flag: 'ğŸ‡§ğŸ‡±' },
    { name: 'Saint Helena', code: '290', flag: 'ğŸ‡¸ğŸ‡­' },
    { name: 'Saint Kitts and Nevis', code: '1-869', flag: 'ğŸ‡°ğŸ‡³' },
    { name: 'Saint Lucia', code: '1-758', flag: 'ğŸ‡±ğŸ‡¨' },
    { name: 'Saint Martin', code: '590', flag: 'ğŸ‡²ğŸ‡«' },
    { name: 'Saint Pierre and Miquelon', code: '508', flag: 'ğŸ‡µğŸ‡²' },
    { name: 'Saint Vincent and the Grenadines', code: '1-784', flag: 'ğŸ‡»ğŸ‡¨' },
    { name: 'Samoa', code: '685', flag: 'ğŸ‡¼ğŸ‡¸' },
    { name: 'San Marino', code: '378', flag: 'ğŸ‡¸ğŸ‡²' },
    { name: 'Sao Tome and Principe', code: '239', flag: 'ğŸ‡¸ğŸ‡¹' },
    { name: 'Saudi Arabia', code: '966', flag: 'ğŸ‡¸ğŸ‡¦' },
    { name: 'Senegal', code: '221', flag: 'ğŸ‡¸ğŸ‡³' },
    { name: 'Serbia', code: '381', flag: 'ğŸ‡·ğŸ‡¸' },
    { name: 'Seychelles', code: '248', flag: 'ğŸ‡¸ğŸ‡¨' },
    { name: 'Sierra Leone', code: '232', flag: 'ğŸ‡¸ğŸ‡±' },
    { name: 'Singapore', code: '65', flag: 'ğŸ‡¸ğŸ‡¬' },
    { name: 'Sint Maarten', code: '1-721', flag: 'ğŸ‡¸ğŸ‡½' },
    { name: 'Slovakia', code: '421', flag: 'ğŸ‡¸ğŸ‡°' },
    { name: 'Slovenia', code: '386', flag: 'ğŸ‡¸ğŸ‡®' },
    { name: 'Solomon Islands', code: '677', flag: 'ğŸ‡¸ğŸ‡§' },
    { name: 'Somalia', code: '252', flag: 'ğŸ‡¸ğŸ‡´' },
    { name: 'South Africa', code: '27', flag: 'ğŸ‡¿ğŸ‡¦' },
    { name: 'South Korea', code: '82', flag: 'ğŸ‡°ğŸ‡·' },
    { name: 'South Sudan', code: '211', flag: 'ğŸ‡¸ğŸ‡¸' },
    { name: 'Spain', code: '34', flag: 'ğŸ‡ªğŸ‡¸' },
    { name: 'Sri Lanka', code: '94', flag: 'ğŸ‡±ğŸ‡°' },
    { name: 'Sudan', code: '249', flag: 'ğŸ‡¸ğŸ‡©' },
    { name: 'Suriname', code: '597', flag: 'ğŸ‡¸ğŸ‡·' },
    { name: 'Svalbard and Jan Mayen', code: '47', flag: 'ğŸ‡¸ğŸ‡¯' },
    { name: 'Swaziland', code: '268', flag: 'ğŸ‡¸ğŸ‡¿' },
    { name: 'Sweden', code: '46', flag: 'ğŸ‡¸ğŸ‡ª' },
    { name: 'Switzerland', code: '41', flag: 'ğŸ‡¨ğŸ‡­' },
    { name: 'Syria', code: '963', flag: 'ğŸ‡¸ğŸ‡¾' },
    { name: 'Taiwan', code: '886', flag: 'ğŸ‡¹ğŸ‡¼' },
    { name: 'Tajikistan', code: '992', flag: 'ğŸ‡¹ğŸ‡¯' },
    { name: 'Tanzania', code: '255', flag: 'ğŸ‡¹ğŸ‡¿' },
    { name: 'Thailand', code: '66', flag: 'ğŸ‡¹ğŸ‡­' },
    { name: 'Togo', code: '228', flag: 'ğŸ‡¹ğŸ‡¬' },
    { name: 'Tokelau', code: '690', flag: 'ğŸ‡¹ğŸ‡°' },
    { name: 'Tonga', code: '676', flag: 'ğŸ‡¹ğŸ‡´' },
    { name: 'Trinidad and Tobago', code: '1-868', flag: 'ğŸ‡¹ğŸ‡¹' },
    { name: 'Tunisia', code: '216', flag: 'ğŸ‡¹ğŸ‡³' },
    { name: 'Turkey', code: '90', flag: 'ğŸ‡¹ğŸ‡·' },
    { name: 'Turkmenistan', code: '993', flag: 'ğŸ‡¹ğŸ‡²' },
    { name: 'Turks and Caicos Islands', code: '1-649', flag: 'ğŸ‡¹ğŸ‡¨' },
    { name: 'Tuvalu', code: '688', flag: 'ğŸ‡¹ğŸ‡»' },
    { name: 'U.S. Virgin Islands', code: '1-340', flag: 'ğŸ‡»ğŸ‡®' },
    { name: 'Uganda', code: '256', flag: 'ğŸ‡ºğŸ‡¬' },
    { name: 'Ukraine', code: '380', flag: 'ğŸ‡ºğŸ‡¦' },
    { name: 'United Arab Emirates', code: '971', flag: 'ğŸ‡¦ğŸ‡ª' },
    { name: 'United Kingdom', code: '44', flag: 'ğŸ‡¬ğŸ‡§' },
    { name: 'United States', code: '1', flag: 'ğŸ‡ºğŸ‡¸' },
    { name: 'Uruguay', code: '598', flag: 'ğŸ‡ºğŸ‡¾' },
    { name: 'Uzbekistan', code: '998', flag: 'ğŸ‡ºğŸ‡¿' },
    { name: 'Vanuatu', code: '678', flag: 'ğŸ‡»ğŸ‡º' },
    { name: 'Vatican', code: '379', flag: 'ğŸ‡»ğŸ‡¦' },
    { name: 'Venezuela', code: '58', flag: 'ğŸ‡»ğŸ‡ª' },
    { name: 'Vietnam', code: '84', flag: 'ğŸ‡»ğŸ‡³' },
    { name: 'Wallis and Futuna', code: '681', flag: 'ğŸ‡¼ğŸ‡«' },
    { name: 'Western Sahara', code: '212', flag: 'ğŸ‡ªğŸ‡­' },
    { name: 'Yemen', code: '967', flag: 'ğŸ‡¾ğŸ‡ª' },
    { name: 'Zambia', code: '260', flag: 'ğŸ‡¿ğŸ‡²' },
    { name: 'Zimbabwe', code: '263', flag: 'ğŸ‡¿ğŸ‡¼' },
].map(c => ({...c, code: c.code.replace('-', '')}));


const CountryCodePicker: FC<{
    value: string;
    onValueChange: (value: string) => void;
    disabled?: boolean;
}> = ({ value, onValueChange, disabled }) => {
    const [open, setOpen] = useState(false);
    const selectedCountry = countries.find(c => c.code === value) || countries.find(c => c.name === 'India');

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button
                    variant="outline"
                    role="combobox"
                    aria-expanded={open}
                    className="w-auto justify-start"
                    disabled={disabled}
                >
                    {selectedCountry?.flag} +{selectedCountry?.code}
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[200px] p-0">
                <Command>
                    <CommandInput placeholder="Search country..." />
                    <CommandList>
                        <CommandEmpty>No country found.</CommandEmpty>
                        <CommandGroup>
                            <ScrollArea className="h-48">
                                {countries.map((country) => (
                                <CommandItem
                                    key={country.code}
                                    value={`${country.name} (${country.code})`}
                                    onSelect={() => {
                                        onValueChange(country.code)
                                        setOpen(false)
                                    }}
                                >
                                    <Check
                                    className={cn(
                                        "mr-2 h-4 w-4",
                                        value === country.code ? "opacity-100" : "opacity-0"
                                    )}
                                    />
                                    {country.flag} {country.name} (+{country.code})
                                </CommandItem>
                                ))}
                            </ScrollArea>
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    )
}

function LoginPageContent() {
  const [countryCode, setCountryCode] = useState('91');
  const [mobileNumber, setMobileNumber] = useState('');
  const [otp, setOtp] = useState('');
  const [sentOtp, setSentOtp] = useState('');
  const [isOtpSent, setIsOtpSent] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [isVerifying, setIsVerifying] = useState(false);
  const router = useRouter();
  const { toast } = useToast();
  const searchParams = useSearchParams();

  const handleSendOtp = async () => {
    const fullWhatsappNumber = `${countryCode}${mobileNumber}`;
    const whatsappRegex = /^\d{1,5}\d{10}$/; // Country code (1-5 digits) + 10-digit number

    if (!fullWhatsappNumber || !whatsappRegex.test(fullWhatsappNumber)) {
        toast({
            variant: 'destructive',
            title: 'Invalid Number Format',
            description: 'Please select a country code and enter a valid 10-digit WhatsApp number.',
        });
        return;
    }

    setIsSending(true);
    try {
        // 1. Check if the user is registered
        const user = await findUserByWhatsapp(fullWhatsappNumber);
        if (!user || !user.clubId) {
            throw new Error("This WhatsApp number is not registered with any club. Please contact your admin.");
        }

        // 2. Check if the number is on WhatsApp
        const verificationResult = await verifyWhatsappNumber({ whatsappNumber: fullWhatsappNumber });
        if (!verificationResult.success || !verificationResult.isOnWhatsApp) {
            throw new Error(verificationResult.error || "This number is not active on WhatsApp.");
        }
        
        // 3. Get club-specific WhatsApp config
        const club = await getClub(user.clubId);
        if (!club) {
            throw new Error("Could not find the club associated with your account.");
        }


      const result = await sendLoginOtp({ whatsappNumber: fullWhatsappNumber, whatsappConfig: club.whatsappConfig || {} });
      if (result.success && result.otp) {
        setSentOtp(result.otp);
        setIsOtpSent(true);
        toast({
          title: 'OTP Sent!',
          description: `An OTP has been sent to ${fullWhatsappNumber}.`,
        });
      } else {
        throw new Error(result.error || 'An unknown error occurred while sending OTP.');
      }
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Failed to Send OTP',
        description: error.message,
      });
    } finally {
      setIsSending(false);
    }
  };

  const handleLogin = async () => {
    if (otp !== sentOtp) {
      toast({
        variant: 'destructive',
        title: 'Invalid OTP',
        description: 'The OTP you entered is incorrect. Please try again.',
      });
      return;
    }

    setIsVerifying(true);
    try {
      const fullWhatsappNumber = `${countryCode}${mobileNumber}`;
      const user = await findUserByWhatsapp(fullWhatsappNumber);

      if (user && user.clubId) {
        localStorage.setItem('chip-maestro-user', JSON.stringify(user));
        localStorage.setItem('chip-maestro-clubId', user.clubId);
        router.replace('/dashboard');
      } else {
        // This case should ideally not be hit if sendLoginOtp is working correctly, but it's a good fallback.
        throw new Error("This WhatsApp number isn't registered with any club. Please contact your admin.");
      }
    } catch (error: any) {
      toast({
        variant: "destructive",
        title: "Login Failed",
        description: error.message,
      });
    } finally {
      setIsVerifying(false);
    }
  };
  
  const handleKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      if (isOtpSent) {
        handleLogin();
      } else {
        handleSendOtp();
      }
    }
  }
  
  const videoUrl = "https://ak03-video-cdn.slidely.com/media/videos/8f/dd/8fddd811b3c3c8238e4f7459bc25f9c6-720p-preview.mp4";

  return (
    <div className="relative flex min-h-screen items-center justify-center p-4">
      <video
        autoPlay
        loop
        muted
        playsInline
        className="absolute top-0 left-0 w-full h-full object-cover -z-20"
        src="https://ak03-video-cdn.slidely.com/media/videos/8f/dd/8fddd811b3c3c8238e4f7459bc25f9c6-720p-preview.mp4"
      >
        Your browser does not support the video tag.
      </video>
      <div className="absolute top-0 left-0 w-full h-full bg-background/50 backdrop-blur-sm -z-10" />
      <Card className="w-full max-w-sm mx-auto">
        <CardHeader className="text-center">
          <div className="mx-auto bg-primary rounded-full p-3 w-fit mb-4">
            <KeyRound className="h-8 w-8 text-primary-foreground" />
          </div>
          <CardTitle>Chip Maestro Login</CardTitle>
          <CardDescription>
            {isOtpSent ? `Enter the OTP sent to +${countryCode}${mobileNumber}.` : 'Enter your WhatsApp number to log in.'}
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {!isOtpSent ? (
            <div className="space-y-2">
              <Label htmlFor="whatsapp-number" className="sr-only">WhatsApp Number</Label>
              <div className="flex gap-2">
                <CountryCodePicker value={countryCode} onValueChange={setCountryCode} />
                <Input
                  id="whatsapp-number"
                  type="tel"
                  placeholder="10-digit number"
                  value={mobileNumber}
                  onChange={(e) => setMobileNumber(e.target.value.replace(/\D/g, ''))}
                  onKeyDown={handleKeyPress}
                />
              </div>
            </div>
          ) : (
            <div className="space-y-2">
              <Label htmlFor="otp" className="sr-only">One-Time Password (OTP)</Label>
              <Input
                id="otp"
                type="text"
                placeholder="4-digit code"
                value={otp}
                onChange={(e) => setOtp(e.target.value)}
                onKeyDown={handleKeyPress}
              />
            </div>
          )}
        </CardContent>
        <CardFooter className="flex flex-col gap-2">
          {!isOtpSent ? (
            <Button onClick={handleSendOtp} disabled={isSending || !mobileNumber} className="w-full">
              {isSending ? <Loader2 className="animate-spin" /> : 'Send OTP'}
            </Button>
          ) : (
            <>
              <Button onClick={handleLogin} disabled={isVerifying || !otp} className="w-full">
                {isVerifying ? <Loader2 className="animate-spin" /> : 'Login'}
              </Button>
              <Button variant="link" onClick={() => setIsOtpSent(false)}>
                Use a different number
              </Button>
            </>
          )}
        </CardFooter>
      </Card>
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <LoginPageContent />
    </Suspense>
  );
}
